@using Microsoft.AspNetCore.Components.Forms

<FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
    <FluentLabel Typo="Typography.H5">Upload ID Document</FluentLabel>
    
    <InputFile OnChange="HandleFileSelected" accept="image/*" class="fluent-input-file" />
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <FluentMessageBar Intent="MessageIntent.Error">
            @errorMessage
        </FluentMessageBar>
    }
    
    @if (imagePreview != null)
    {
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
            <FluentLabel Typo="Typography.Body"><strong>Preview:</strong></FluentLabel>
            <img src="@imagePreview" alt="Document preview" style="max-width: 100%; max-height: 400px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
        </FluentStack>
    }
</FluentStack>

@code {
    private string? imagePreview;
    private string? errorMessage;
    private const long MaxFileSize = 10 * 1024 * 1024; // 10MB
    
    [Parameter]
    public EventCallback<IBrowserFile> OnFileUploaded { get; set; }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        errorMessage = null;
        imagePreview = null;
        
        var file = e.File;
        
        // Validate file
        if (file == null)
        {
            errorMessage = "No file selected";
            return;
        }
        
        // Validate file type
        if (!file.ContentType.StartsWith("image/"))
        {
            errorMessage = "Please select an image file";
            return;
        }
        
        // Validate file size
        if (file.Size > MaxFileSize)
        {
            errorMessage = $"File size must be less than {MaxFileSize / 1024 / 1024}MB";
            return;
        }
        
        try
        {
            // Create preview
            var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800);
            using var stream = resizedImage.OpenReadStream(MaxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            imagePreview = $"data:image/jpeg;base64,{base64}";
            
            // Notify parent component
            await OnFileUploaded.InvokeAsync(file);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing file: {ex.Message}";
        }
    }
}
