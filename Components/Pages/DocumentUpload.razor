@using Microsoft.AspNetCore.Components.Forms

<div class="document-upload">
    <h3>Upload ID Document</h3>
    
    <InputFile OnChange="HandleFileSelected" accept="image/*" class="form-control" />
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-2">@errorMessage</div>
    }
    
    @if (imagePreview != null)
    {
        <div class="mt-3">
            <h5>Preview:</h5>
            <img src="@imagePreview" alt="Document preview" class="img-thumbnail" style="max-width: 400px; max-height: 400px;" />
        </div>
    }
</div>

@code {
    private string? imagePreview;
    private string? errorMessage;
    private const long MaxFileSize = 10 * 1024 * 1024; // 10MB
    
    [Parameter]
    public EventCallback<IBrowserFile> OnFileUploaded { get; set; }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        errorMessage = null;
        imagePreview = null;
        
        var file = e.File;
        
        // Validate file
        if (file == null)
        {
            errorMessage = "No file selected";
            return;
        }
        
        // Validate file type
        if (!file.ContentType.StartsWith("image/"))
        {
            errorMessage = "Please select an image file";
            return;
        }
        
        // Validate file size
        if (file.Size > MaxFileSize)
        {
            errorMessage = $"File size must be less than {MaxFileSize / 1024 / 1024}MB";
            return;
        }
        
        try
        {
            // Create preview
            var resizedImage = await file.RequestImageFileAsync("image/jpeg", 800, 800);
            using var stream = resizedImage.OpenReadStream(MaxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            imagePreview = $"data:image/jpeg;base64,{base64}";
            
            // Notify parent component
            await OnFileUploaded.InvokeAsync(file);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing file: {ex.Message}";
        }
    }
}
