@inject IJSRuntime JSRuntime

<div class="selfie-capture">
    <h3>Capture Selfie</h3>
    
    <div class="mb-3">
        @if (!isCameraActive)
        {
            <button class="btn btn-primary" @onclick="StartCamera">Start Camera</button>
        }
        else
        {
            <button class="btn btn-danger me-2" @onclick="StopCamera">Stop Camera</button>
            <button class="btn btn-success" @onclick="CaptureImage">Capture Photo</button>
        }
    </div>
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    
    <div class="camera-container">
        @if (isCameraActive)
        {
            <video id="videoElement" autoplay playsinline style="max-width: 100%; border: 2px solid #ddd;"></video>
        }
        
        @if (!string.IsNullOrEmpty(capturedImage))
        {
            <div class="mt-3">
                <h5>Captured Image:</h5>
                <img src="@capturedImage" alt="Captured selfie" class="img-thumbnail" style="max-width: 400px;" />
            </div>
        }
    </div>
    
    <canvas id="canvasElement" style="display: none;"></canvas>
</div>

@code {
    private bool isCameraActive = false;
    private string? capturedImage;
    private string? errorMessage;
    
    [Parameter]
    public EventCallback<string> OnImageCaptured { get; set; }

    private async Task StartCamera()
    {
        try
        {
            errorMessage = null;
            var success = await JSRuntime.InvokeAsync<bool>("cameraInterop.startCamera", "videoElement");
            
            if (success)
            {
                isCameraActive = true;
            }
            else
            {
                errorMessage = "Failed to start camera. Please check permissions.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error starting camera: {ex.Message}";
        }
    }

    private async Task StopCamera()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("cameraInterop.stopCamera");
            isCameraActive = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error stopping camera: {ex.Message}";
        }
    }

    private async Task CaptureImage()
    {
        try
        {
            errorMessage = null;
            capturedImage = await JSRuntime.InvokeAsync<string>("cameraInterop.captureImage", "videoElement", "canvasElement");
            
            if (!string.IsNullOrEmpty(capturedImage))
            {
                await OnImageCaptured.InvokeAsync(capturedImage);
                await StopCamera();
            }
            else
            {
                errorMessage = "Failed to capture image";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error capturing image: {ex.Message}";
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        if (isCameraActive)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("cameraInterop.stopCamera");
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
    }
}
